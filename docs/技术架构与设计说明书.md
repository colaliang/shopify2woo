# 技术架构与设计说明书（Shopify → Woo 导入工具）

## 1. 总体架构
- 架构组成：
  - 浏览器扩展（MV3）：轻入口，点击图标打开 Web 前端站点。
  - Web 前端（Next.js 16 + Tailwind）：`/import`、`/config` 页面与基础导航。
  - Serverless 后端（Vercel Route Handlers）：Shopify 抓取、数据映射、Woo 导入、Supabase 读写。
  - 数据层（Supabase）：配置与导入作业表，RLS 保障。
- 运行时：
  - 前端渲染：Next.js App Router，客户端交互 + 服务器端数据路由。
  - 后端执行：Vercel Serverless（Node.js 环境），无状态、短时执行。

## 2. 技术栈与版本
- Next.js 16（App Router） + TypeScript
- Tailwind CSS（样式）
- Supabase（Postgres + Auth + Storage）
- Vercel（部署与 Serverless 托管）
- Chrome 扩展（Manifest V3）

## 3. 前端设计
- 路由：
  - `/`：首页导航至 Import 与 Config。
  - `/import`：表单提交至 `POST /api/import/shopify`。
  - `/config`：表单提交至 `POST /api/config/save`；初次加载调用 `GET /api/config/get`。
- 组件：
  - 表单组件：受控输入、校验与加载状态。
  - 消息反馈：成功/失败提示。
- 状态管理：
  - 初版由页面自身 state 管理；后续引入 Supabase 获取和持久化配置。

## 4. 后端设计（Vercel Route Handlers）
- 模块划分：
  - 配置接口：`GET/POST /api/config/*` 与 Supabase 通信（服务端持有 `service_role`）。
  - 导入接口：`POST /api/import/shopify`，解析 handle 并驱动抓取→映射→Woo 导入→记录作业状态。
  - Shopify 抓取器：
    - `GET https://<base>/products/<handle>.json`（单品）
    - `GET https://<base>/products.json?limit=250&page=n`（分页）
  - Woo 客户端：封装 `products` 与 `variations` 端点调用，以及分类、标签、品牌术语处理。
- 抽象函数（TS 版本对齐 Python 逻辑）：
  - `cleanImageUrl(url)`: 清理查询参数。
  - `createAttributes(product)`: 依据 `options` 生成属性。
  - `buildDefaultAttributes(product, firstVariant)`: 从首个变体设定默认属性值。
  - `computePriceFields(variant)`: 计算 `regular_price` 与 `sale_price`（对比价逻辑）。
  - `createVariations(product, parentWeight, parentImage)`: 生成变体 payload，包含 SKU 唯一性保证与图片映射、条码元数据。
  - `ensureTerms(kind, names)`: 分类与标签的查询与创建。
  - `syncBrandOrFallbackAsTag(vendor)`: 优先品牌 taxonomy，不可用时回退到标签。
  - `createOrUpdateProduct(product)`: 按 SKU 或 slug 查重并创建/更新，变量产品附加 `default_attributes` 与变体创建。
  - 错误重试：图片上传失败（`woocommerce_product_image_upload_error`）的指数退避重试；网络 429/5xx 重试。

## 5. 数据库设计（Supabase）
- 表：
  - `user_configs`
    - `id`: uuid 主键
    - `wordpress_url`: text
    - `consumer_key`: text（加密存储或受限访问）
    - `consumer_secret`: text（加密存储或受限访问）
    - `created_at` / `updated_at`: timestamptz
  - `import_jobs`
    - `id`: uuid 主键
    - `shopify_base`: text
    - `product_links`: jsonb（数组）
    - `status`: text（queued/running/succeeded/failed）
    - `error`: text（失败原因，脱敏）
    - `created_at`: timestamptz
- RLS（行级安全）：
  - 客户端使用 `anon key` 仅读/写属于自己的配置（可根据 auth 设置）；
  - 服务端（Vercel）使用 `service_role key` 进行 Woo 导入与密钥读取（不暴露到客户端）。

## 6. 安全与秘钥管理
- 环境变量：
  - Vercel（Serverless）：`SUPABASE_URL`、`SUPABASE_SERVICE_ROLE_KEY`、`WORDPRESS_URL`（可选，建议改从数据库读）。
  - 客户端（公开）：`NEXT_PUBLIC_SUPABASE_URL`、`NEXT_PUBLIC_SUPABASE_ANON_KEY`。
- 原则：
  - WooCommerce 的 `CONSUMER_KEY/SECRET` 不在前端或扩展中出现；仅在服务端使用。
  - `.env` 中的敏感内容迁移到 Supabase；仓库不保留明文秘钥。

## 7. API 设计
- `POST /api/import/shopify`
  - 请求：`{ shopifyBaseUrl: string, productLinks: string[] }`
  - 处理：解析 handle → 抓取产品 → 映射 → 创建/更新 Woo → 记录作业。
  - 响应：`{ ok: true, requestId: string, count: number }` 或 `{ error: string }`
- `GET /api/config/get`
  - 响应：`{ config: {...} | null }`
- `POST /api/config/save`
  - 请求：`{ wordpressUrl, consumerKey, consumerSecret }`
  - 响应：`{ ok: true }` 或 `{ error: string }`
- 错误与码：
  - 400：参数不完整或非法。
  - 500：内部错误（返回脱敏信息）。

## 8. 迁移与映射细节（Python → TS）
- 价格：`compare_at_price > price` 时，`regular=compare_at_price`、`sale=price`；否则 `regular=price`。
- SKU：
  - 变体：先用 `variant.sku`，缺失用 `variant.id`；若占用则用 fallback（`product.id-variant.id` 等），仍冲突则追加时间片后缀。
  - 父产品：变量产品用 `handle` 或 `id`；简单产品用首变体 SKU 或 `handle/id`。
- 分类与标签：
  - 分类：`product_type` 支持 `:/,` 多分隔；不存在则创建。
  - 标签：`tags`（字符串或数组）清洗后创建并关联。
- 品牌：优先 `products/brands` 端点；失败回退标签。
- 默认属性：依据首变体 `option1/2/3` 设置到父产品的 `default_attributes`。
- 图片：清理查询参数；上传失败重试（指数退避）。

## 9. 部署与环境
- 本地开发：
  - `npm run dev` 启动站点：`http://localhost:3000/`。
  - Chrome 扩展：开发者模式加载 `chrome-extension`。
- Vercel 部署：
  - 配置环境变量（服务端与客户端）。
  - Next.js 自动构建与部署；Serverless 路由随代码发布。
- Supabase：
  - 创建项目与表；设定 RLS；生成客户端 `anon key` 与服务端 `service_role key`。

## 10. 测试与监控
- 单元测试：映射函数与正则解析。
- 集成测试：
  - 伪造 Shopify 产品 JSON，验证导入到 Woo 的 payload 构造。
  - API 路由的参数校验与错误码。
- 监控与日志：
  - 导入作业状态记录到 `import_jobs`；错误脱敏。

## 11. 路线图
- 阶段 1：完成 Supabase 接入与配置保存（M2）。
- 阶段 2：实现完整导入链路到 Woo（M3）。
- 阶段 3：全站导入与进度视图（M4）。
- 阶段 4：Chrome 扩展打包发布与更新。