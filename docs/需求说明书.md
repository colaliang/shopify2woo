# 需求说明书（Shopify → Woo 导入工具：浏览器插件 + Web + Serverless）

## 1. 概述
- 目标：将现有 Python 脚本迁移为 Chrome 扩展 + Next.js 前端 + Vercel Serverless 后端，统一使用 Supabase 做配置与导入任务存储，实现从 Shopify 抓取产品并导入到 WooCommerce 的可视化工具。
- 当前状态：已有 `shopify2woo.py` 能完成抓取、映射与 Woo 导入；仓库已新建 `shopify2woo-web`（Next.js + Tailwind）、`chrome-extension` 骨架与基础页面。

## 2. 范围
- 在范围：
  - 浏览器扩展（MV3）入口：点击图标打开 Web 前端站点。
  - Web 前端（Next.js + Tailwind）：Import 页、Config 页。
  - Serverless API（Vercel）：抓取 Shopify 产品、映射为 Woo 数据结构并创建/更新、存储配置与导入作业。
  - Supabase 存储：配置与导入作业记录。
- 不在范围：
  - Shopify Admin API（私有令牌）深度集成（如店铺关闭 `products.json` 时的替代方案）——可作为后续扩展。
  - 大规模任务队列/分布式处理。

## 3. 用户与场景
- 用户：
  - 运营人员：在浏览器中输入 Shopify 信息进行导入。
  - 管理人员：维护 WordPress/WooCommerce 配置（站点 URL、API 密钥）。
- 场景：
  - 指定产品导入：输入 Shopify 产品链接或 handle，创建/更新至 Woo。
  - 全站导入（后续扩展）：输入 Shopify 站点，分页拉取全部产品批量导入。

## 4. 功能需求
- Import 页面（/import）：
  - 字段：`Shopify 站点网址`（必填，示例 `https://yourshop.myshopify.com`）、`产品链接或 handle`（可多条，逗号或换行分隔）。
  - 行为：提交后调用 `POST /api/import/shopify`，后端解析 handle，抓取并导入到 Woo。
  - 反馈：显示请求 ID、计数、错误信息。
- Config 页面（/config）：
  - 字段：`WordPress 站点网址`、`CONSUMER_KEY`、`CONSUMER_SECRET`。
  - 行为：调用 `GET/POST /api/config/*` 保存/获取配置（最终存 Supabase）。
  - 安全：密钥不在前端或扩展源码中存储；仅服务端持有读取权限。
- Chrome 扩展（MV3）：
  - 点击图标：在新标签打开站点（开发：`http://localhost:3000`；生产：Vercel URL）。
  - 权限：最小权限（如 `tabs`）。
- Serverless 后端：
  - Shopify 抓取：`/products/<handle>.json` 或分页 `/products.json`。
  - Woo 导入：创建/更新产品与变体；分类、标签与品牌映射；图片上传失败重试。
  - 日志：导入作业状态与错误信息记录到 Supabase。
- Supabase 存储：
  - `user_configs`：站点与密钥；服务端读写。
  - `import_jobs`：导入请求、目标、状态与错误。

## 5. 非功能需求
- 安全：
  - Woo API 密钥仅保存在服务端数据库；客户端使用匿名 key 访问非敏感数据。
  - HTTPS；错误信息脱敏。
- 稳定性与性能：
  - 对 Woo 图片上传失败做指数退避重试；对 429/5xx 做重试。
  - 并发控制与节流（后续迭代）。
- 可用性：
  - 表单校验、清晰的错误提示与进度反馈。
- 可维护性：
  - 代码模块化，函数职责单一；文档完善。

## 6. 接口契约（初版）
- `POST /api/import/shopify`
  - 请求：`{ shopifyBaseUrl: string, productLinks: string[] }`
  - 响应：`{ ok: true, requestId: string, count: number }` 或 `{ error: string }`
- `GET /api/config/get`
  - 响应：`{ config: { wordpressUrl, consumerKey, consumerSecret } | null }`
- `POST /api/config/save`
  - 请求：`{ wordpressUrl: string, consumerKey: string, consumerSecret: string }`
  - 响应：`{ ok: true }` 或 `{ error: string }`

## 7. 验收标准
- 导航首页可访问，能进入 `/import` 与 `/config`。
- `/config` 可提交并在服务端成功保存（占位阶段回显，最终写入 Supabase）。
- `/import` 可提交并返回请求信息；后续版本能实际创建/更新 Woo 产品与变体。
- Chrome 扩展点击可打开站点。

## 8. 约束与风险
- Shopify 公共 `.json` 接口可能关闭：需后续支持 Admin API。
- Woo 图片上传失败或远端图片不可达：需重试与错误信息记录。
- 仓库目前 `.env` 含密钥：需迁移到 Supabase 并删除明文存储。

## 9. 里程碑
- M1：完成前端页面与扩展骨架、占位 API（已完成）。
- M2：接入 Supabase，完成配置保存与读取。
- M3：迁移 Python 导入逻辑到 TS/Serverless；联通 Woo。
- M4：完善全站导入与进度跟踪；扩展打包与发布。